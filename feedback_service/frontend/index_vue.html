<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feedback Submission</title>
</head>
<body>
  <div id="app" class="container">
    <h1>Feedback Submission</h1>

    <div v-if="feedbackError" style="color: white; background: #f44336; padding: 10px;">
      {{ feedbackError }}
    </div>

    <div v-if="menuItem">
      <p><strong>Menu Item:</strong> {{ menuItem.name }}</p>
      <p><strong>Description:</strong> {{ menuItem.description }}</p>
      <p><strong>Price:</strong> ${{ menuItem.price }}</p>
      <p><strong>Availability:</strong> {{ menuItem.availability_status ? 'Available' : 'Unavailable' }}</p>

      <div>
        <label for="rating">Rating:</label>
        <select v-model="rating">
          <option disabled value="">Select Rating</option>
          <option v-for="n in 5" :key="n" :value="n">{{ n }}</option>
        </select>
      </div>

      <div>
        <label>Tags (comma separated):</label>
        <input v-model="tags" placeholder="e.g., spicy, vegan" />
      </div>

      <div>
        <label>Description:</label>
        <textarea v-model="description"></textarea>
      </div>

      <button @click="submitFeedback">Submit Feedback</button>
    </div>

  </div>

  <!-- Vue and Axios -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          customerID: "",
          orderID: "",
          menuItemIDs: [],
          currentMenuItemIndex: 0,
          menuItem: null,
          rating: "",
          tags: "",
          description: "",
          feedbackError: ""
        };
      },
      mounted() {
        console.log("Page mounted");
        this.customerID = new URLSearchParams(window.location.search).get('customerID');
        if (this.customerID) {
          this.fetchOrderDetails();
        } else {
          this.feedbackError = "Missing customer ID in URL";
        }
      },
      methods: {
        async fetchOrderDetails() {
          try {
            const response = await axios.get(`http://localhost:5005/get_order_details/${this.customerID}`);
            console.log("Order details:", response.data);

            this.orderID = response.data.OrderID;
            this.menuItemIDs = response.data.MenuItemIDs.split(",");
            this.loadMenuItem();
          } catch (error) {
            console.error("Error fetching order details:", error);
            this.feedbackError = "Failed to load order details.";
          }
        },

        async loadMenuItem() {
          if (this.currentMenuItemIndex >= this.menuItemIDs.length) {
            alert("All feedback submitted!");
            return;
          }

          const itemID = this.menuItemIDs[this.currentMenuItemIndex].trim();
          try {
            const response = await axios.get(`http://localhost:5002/menu/item/${itemID}`);
            console.log("Menu item:", response.data);

            this.menuItem = response.data;
            this.rating = "";
            this.tags = "";
            this.description = "";
          } catch (error) {
            console.error("Error fetching menu item:", error);
            this.feedbackError = "Failed to load menu item details.";
          }
        },

        async submitFeedback() {
          try {
            const feedbackPayload = {
              order_id: this.orderID,
              menu_item_id: this.menuItem.id,
              rating: this.rating,
              tags: this.tags.split(',').map(tag => tag.trim()),
              description: this.description
            };

            console.log("Submitting feedback:", feedbackPayload);

            await axios.post("http://localhost:5005/submit_feedback", feedbackPayload);
            this.currentMenuItemIndex++;
            this.loadMenuItem();
          } catch (error) {
            console.error("Error submitting feedback:", error);
            this.feedbackError = "Failed to submit feedback.";
          }
        }
      }
    });

    app.mount('#app');
  </script>
</body>
</html>
